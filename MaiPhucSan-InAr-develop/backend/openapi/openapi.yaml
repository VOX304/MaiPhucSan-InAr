openapi: 3.0.3
info:
  title: HighPerformance Integration Backend API
  version: "2.0.0"
  description: |
    Node.js backend for the semester project **HighPerformance**.

    Key goals:
    - TR1/TR3: Express.js REST API documented via OpenAPI + Swagger UI
    - TR2: MongoDB persistence (via Mongoose)
    - TR4: integration boundaries for OrangeHRM + OpenCRX
    - TR8: integration tests can stub dependencies
    - TR9: optional Camunda workflow endpoints
servers:
  - url: http://localhost:3000

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string

    AuthLoginRequest:
      type: object
      required: [username, password]
      properties:
        username:
          type: string
        password:
          type: string

    AuthUser:
      type: object
      properties:
        username:
          type: string
        role:
          type: string
          enum: [CEO, HR, SALESMAN]
        employeeId:
          type: string
          nullable: true
          pattern: '^E\\d+$'

    AuthLoginResponse:
      type: object
      properties:
        token:
          type: string
        user:
          $ref: "#/components/schemas/AuthUser"

    EnvelopeAuthLogin:
      type: object
      properties:
        data:
          $ref: "#/components/schemas/AuthLoginResponse"

    EnvelopeAuthUser:
      type: object
      properties:
        data:
          $ref: "#/components/schemas/AuthUser"

    Salesman:
      type: object
      properties:
        _id: { type: string }
        employeeId:
          type: string
          pattern: '^E\\d+$'
        name: { type: string }
        department: { type: string }
        performanceYear: { type: integer }
        orangeHrmId:
          type: string
          nullable: true

    EnvelopeSalesman:
      type: object
      properties:
        data:
          $ref: "#/components/schemas/Salesman"

    CreateSalesmanRequest:
      type: object
      required: [employeeId]
      properties:
        employeeId:
          type: string
          pattern: '^E\\d+$'
        name: { type: string }
        department: { type: string }
        performanceYear: { type: integer }


    EnvelopeSalesmen:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Salesman"

    SocialPerformanceRecord:
      type: object
      properties:
        _id: { type: string }
        salesmanEmployeeId:
          type: string
          pattern: '^E\\d+$'
        year: { type: integer }
        criterionKey: { type: string }
        criterionName: { type: string }
        targetValue: { type: number }
        actualValue: { type: number }
        weight: { type: number }
        supervisorRating: { type: number }
        peerRating: { type: number }
        computedBonusEur: { type: number }
        remark: { type: string }

    EnvelopeSocialRecords:
      type: object
      properties:
        data:
          type: object
          properties:
            records:
              type: array
              items:
                $ref: "#/components/schemas/SocialPerformanceRecord"
            socialTotalEur:
              type: number

    CreateSocialPerformanceRequest:
      type: object
      required: [salesmanEmployeeId, year, criterionKey, criterionName, targetValue, weight]
      properties:
        salesmanEmployeeId:
          type: string
          pattern: '^E\\d+$'
        year: { type: integer }
        criterionKey: { type: string }
        criterionName: { type: string }
        targetValue: { type: number, minimum: 0 }
        actualValue: { type: number, minimum: 0 }
        weight: { type: number, minimum: 0, maximum: 1 }
        supervisorRating: { type: number, minimum: 1, maximum: 5 }
        peerRating: { type: number, minimum: 1, maximum: 5 }
        remark: { type: string }

    OrderEvaluationRecord:
      type: object
      properties:
        _id: { type: string }
        salesmanEmployeeId:
          type: string
          pattern: '^E\\d+$'
        year: { type: integer }
        orderId: { type: string }
        productName: { type: string }
        clientName: { type: string }
        clientRanking: { type: number }
        closingProbability: { type: number }
        itemsCount: { type: number }
        revenueEur: { type: number }
        computedBonusEur: { type: number }
        remark: { type: string }

    EnvelopeOrders:
      type: object
      properties:
        data:
          type: object
          properties:
            records:
              type: array
              items:
                $ref: "#/components/schemas/OrderEvaluationRecord"
            ordersTotalEur:
              type: number
    
    CreateOrderEvaluationRequest:
      type: object
      required: [salesmanEmployeeId, year, orderId]
      properties:
        salesmanEmployeeId:
          type: string
          pattern: '^E\\d+$'
        year: { type: integer }
        orderId: { type: string }
        productName: { type: string }
        clientName: { type: string }
        clientRanking: { type: number }
        closingProbability: { type: number }
        itemsCount: { type: number }
        revenueEur: { type: number }
        remark: { type: string }

    BonusComputation:
      type: object
      properties:
        _id: { type: string }
        salesmanEmployeeId:
          type: string
          pattern: '^E\\d+$'
        year: { type: integer }
        socialTotalEur: { type: number }
        ordersTotalEur: { type: number }
        totalBonusEur: { type: number }
        status: { type: string }
        remarks:
          type: array
          items:
            type: object
            properties:
              byUsername: { type: string }
              role: { type: string }
              text: { type: string }
              createdAt: { type: string }
        details:
          type: object
          nullable: true

    EnvelopeBonus:
      type: object
      properties:
        data:
          $ref: "#/components/schemas/BonusComputation"

    EnvelopeBonusList:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/BonusComputation"

    Qualification:
      type: object
      properties:
        _id: { type: string }
        salesmanEmployeeId:
          type: string
          pattern: '^E\\d+$'
        year: { type: integer }
        title: { type: string }
        description: { type: string }
        createdBy: { type: string }
        storedInOrangeHrmAt:
          type: string
          nullable: true

    EnvelopeQualifications:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Qualification"

    BonusStatistics:
      type: object
      properties:
        year: { type: integer }
        items:
          type: array
          items:
            type: object
            properties:
              employeeId:
                type: string
                pattern: '^E\\d+$'
              totalBonusEur: { type: number }
              socialTotalEur: { type: number }
              ordersTotalEur: { type: number }

    EnvelopeStatistics:
      type: object
      properties:
        data:
          $ref: "#/components/schemas/BonusStatistics"

    DependenciesHealth:
      type: object
      properties:
        orangehrm:
          type: object
          properties: { reachable: { type: boolean } }
        opencrx:
          type: object
          properties: { reachable: { type: boolean } }
        mongodb:
          type: object
          properties: { reachable: { type: boolean } }
        camunda:
          type: object
          properties: { reachable: { type: boolean } }

    EnvelopeDependenciesHealth:
      type: object
      properties:
        data:
          $ref: "#/components/schemas/DependenciesHealth"

paths:
  /:
    get:
      operationId: rootRedirect
      summary: API root (redirects to /api/v1)
      security: []
      responses:
        "302":
          description: Redirect to /api/v1

  /api/v1:
    get:
      operationId: apiRoot
      summary: API discovery endpoint
      security: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string }
                  docs: { type: string }
                  openapi: { type: string }

  /openapi.yaml:
    get:
      operationId: getOpenAPIYAML
      summary: OpenAPI spec in YAML format
      security: []
      responses:
        "200":
          description: OK

  /openapi.json:
    get:
      operationId: getOpenAPIJSON
      summary: OpenAPI spec in JSON format
      security: []
      responses:
        "200":
          description: OK

  /api/v1/auth/login:
    post:
      operationId: authLogin
      security: []
      summary: Login and receive JWT
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthLoginRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EnvelopeAuthLogin"
        "400":
          description: Bad Request
        "401":
          description: Unauthorized

  /api/v1/auth/me:
    get:
      operationId: authMe
      summary: Get current user
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EnvelopeAuthUser"
        "400":
          description: Bad Request

  /api/v1/salesmen:
    get:
      operationId: listSalesmen
      summary: List salesmen
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EnvelopeSalesmen"
        "400":
          description: Bad Request
    post:
      operationId: createSalesman
      summary: Create salesman (HR)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateSalesmanRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EnvelopeSalesman"
        "400":
          description: Bad Request

  /api/v1/salesmen/consolidated:
    get:
      operationId: consolidatedSalesmen
      summary: Consolidated view for all salesmen
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
        "400":
          description: Bad Request

  /api/v1/salesmen/{employeeId}:
    get:
      operationId: getSalesmanByEmployeeId
      summary: Get salesman by employeeId
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: employeeId
          required: true
          schema:
            type: string
            pattern: '^E\\d+$'
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EnvelopeSalesman"
        "404":
          description: Not found
        "400":
          description: Bad Request
    patch:
      operationId: updateSalesman
      summary: Update salesman (HR)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: employeeId
          required: true
          schema:
            type: string
            pattern: '^E\\d+$'
      responses:
        "200":
          description: OK
        "400":
          description: Bad Request

  /api/v1/salesmen/{employeeId}/sync:
    post:
      operationId: syncSalesmanFromOrangeHrm
      summary: Sync salesman master data from OrangeHRM
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: employeeId
          required: true
          schema:
            type: string
            pattern: '^E\\d+$'
      responses:
        "200":
          description: OK
        "400":
          description: Bad Request

  /api/v1/salesmen/{employeeId}/consolidated:
    get:
      operationId: consolidatedSalesman
      summary: Consolidated view for one salesman
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: employeeId
          required: true
          schema:
            type: string
            pattern: '^E\\d+$'
        - in: query
          name: year
          schema: { type: integer }
      responses:
        "200":
          description: OK
        "400":
          description: Bad Request

  /api/v1/performance/social/{employeeId}:
    get:
      operationId: listSocialPerformanceForSalesman
      summary: List social performance records for a salesman
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: employeeId
          required: true
          schema:
            type: string
            pattern: '^E\\d+$'
        - in: query
          name: year
          schema: { type: integer }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EnvelopeSocialRecords"
        "400":
          description: Bad Request

  /api/v1/performance/social:
    post:
      operationId: createSocialPerformance
      summary: Create a social performance record (HR)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateSocialPerformanceRequest"
      responses:
        "201":
          description: Created
        "400":
          description: Bad Request

  /api/v1/performance/social/records/{recordId}:
    patch:
      operationId: updateSocialPerformanceRecord
      summary: Update target/actual/ratings of a social performance record (HR)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: recordId
          required: true
          schema:
            type: string
            pattern: '^[0-9a-fA-F]{24}$'
      responses:
        "200":
          description: OK
        "400":
          description: Bad Request

  /api/v1/orders/{employeeId}:
    get:
      operationId: listOrderEvaluationRecords
      summary: List order evaluation records for a salesman (optional refresh from OpenCRX)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: employeeId
          required: true
          schema:
            type: string
            pattern: '^E\\d+$'
        - in: query
          name: year
          schema: { type: integer }
        - in: query
          name: refresh
          schema: { type: boolean }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EnvelopeOrders"
        "400":
          description: Bad Request

  /api/v1/orders:
    post:
      operationId: createOrderEvaluation
      summary: Create an order evaluation record (HR)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateOrderEvaluationRequest"
      responses:
        "201":
          description: Created
        "400":
          description: Bad Request

  /api/v1/bonus/{employeeId}:
    get:
      operationId: getBonusComputation
      summary: Get bonus computation for a salesman
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: employeeId
          required: true
          schema:
            type: string
            pattern: '^E\\d+$'
        - in: query
          name: year
          schema: { type: integer }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EnvelopeBonus"
        "404":
          description: Not found
        "400":
          description: Bad Request

  /api/v1/bonus/{employeeId}/compute:
    post:
      operationId: computeBonusForSalesman
      summary: Compute bonus for a salesman (CEO)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: employeeId
          required: true
          schema:
            type: string
            pattern: '^E\\d+$'
        - in: query
          name: year
          schema: { type: integer }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EnvelopeBonus"
        "400":
          description: Bad Request

  /api/v1/bonus/{employeeId}/history:
    get:
      operationId: listBonusHistory
      summary: List bonus computations of a salesman
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: employeeId
          required: true
          schema:
            type: string
            pattern: '^E\\d+$'
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EnvelopeBonusList"
        "400":
          description: Bad Request

  /api/v1/bonus/{employeeId}/remarks:
    post:
      operationId: addBonusRemark
      summary: Add a remark to a bonus computation
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: employeeId
          required: true
          schema:
            type: string
            pattern: '^E\\d+$'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [text]
              properties:
                text: { type: string }
      responses:
        "200":
          description: OK
        "400":
          description: Bad Request

  /api/v1/bonus/{employeeId}/approve/ceo:
    post:
      operationId: approveBonusCeo
      parameters:
        - in: path
          name: employeeId
          required: true
          schema:
            type: string
            pattern: '^E\\d+$'
      summary: CEO approves a computed bonus
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
        "400":
          description: Bad Request

  /api/v1/bonus/{employeeId}/approve/hr:
    post:
      operationId: approveBonusHr
      parameters:
        - in: path
          name: employeeId
          required: true
          schema:
            type: string
            pattern: '^E\\d+$'
      summary: HR approves and stores total bonus in OrangeHRM
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
        "400":
          description: Bad Request

  /api/v1/bonus/{employeeId}/release:
    post:
      operationId: releaseFinalBonus
      parameters:
        - in: path
          name: employeeId
          required: true
          schema:
            type: string
            pattern: '^E\\d+$'
      summary: Release final bonus to salesman
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
        "400":
          description: Bad Request

  /api/v1/bonus/{employeeId}/confirm:
    post:
      operationId: confirmBonusBySalesman
      parameters:
        - in: path
          name: employeeId
          required: true
          schema:
            type: string
            pattern: '^E\\d+$'
      summary: Salesman confirms final bonus computation
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
        "400":
          description: Bad Request

  /api/v1/qualifications/{employeeId}:
    get:
      operationId: listQualifications
      summary: List qualifications of a salesman
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: employeeId
          required: true
          schema:
            type: string
            pattern: '^E\\d+$'
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EnvelopeQualifications"
        "400":
          description: Bad Request
    post:
      operationId: createQualification
      summary: Create a qualification (CEO)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: employeeId
          required: true
          schema:
            type: string
            pattern: '^E\\d+$'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [year, title]
              properties:
                year:
                  type: integer
                  minimum: 2000
                  maximum: 2100
                title:
                  type: string
                description:
                  type: string
                storeInOrangeHrm:
                  type: boolean
      responses:
        "201":
          description: Created
        "400":
          description: Bad Request

  /api/v1/statistics/bonus:
    get:
      operationId: getBonusStatistics
      summary: Bonus totals for charts
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EnvelopeStatistics"
        "400":
          description: Bad Request

  /api/v1/workflow/bonus/{employeeId}/start:
    post:
      operationId: startCamundaBonusWorkflow
      parameters:
        - in: path
          name: employeeId
          required: true
          schema:
            type: string
            pattern: '^E\\d+$'
      summary: Start Camunda bonus approval process
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
        "400":
          description: Bad Request

  /api/v1/workflow/process/{processInstanceId}/tasks:
    get:
      operationId: listCamundaTasksForProcess
      summary: List Camunda tasks for a process instance
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: processInstanceId
          required: true
          schema:
            type: string
            minLength: 1
      responses:
        "200":
          description: OK
        "400":
          description: Bad Request

  /api/v1/workflow/tasks/{taskId}/complete:
    post:
      operationId: completeCamundaTask
      summary: Complete a Camunda task
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: taskId
          required: true
          schema:
            type: string
            minLength: 1
      responses:
        "200":
          description: OK
        "400":
          description: Bad Request

  /api/v1/odoo/employees:
    get:
      operationId: getOdooEmployees
      summary: Fetch employees from Odoo (if configured)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
        "400":
          description: Bad Request

  /api/v1/integration/health:
    get:
      operationId: getIntegrationHealth
      summary: Dependency reachability overview (OrangeHRM/OpenCRX/MongoDB/Camunda)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EnvelopeDependenciesHealth"
        "400":
          description: Bad Request
